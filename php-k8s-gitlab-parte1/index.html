


<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../fontawesome/solid/share-alt-square">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.2">
    
    
      
        <title>Subindo uma aplicação PHP no Kubernetes com Gitlab-CI - Parte 1 - Construindo a imagem da aplicação - Gustavo Antão Website</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a2408e81.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#subindo-uma-aplicacao-php-no-kubernetes-com-gitlab-ci-parte-1-construindo-a-imagem-da-aplicacao" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Gustavo Antão Website" class="md-header-nav__button md-logo" aria-label="Gustavo Antão Website">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M448 80v352c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V80c0-26.51 21.49-48 48-48h352c26.51 0 48 21.49 48 48zM304 296c-14.562 0-27.823 5.561-37.783 14.671l-67.958-40.775a56.339 56.339 0 000-27.793l67.958-40.775C276.177 210.439 289.438 216 304 216c30.928 0 56-25.072 56-56s-25.072-56-56-56-56 25.072-56 56c0 4.797.605 9.453 1.74 13.897l-67.958 40.775C171.823 205.561 158.562 200 144 200c-30.928 0-56 25.072-56 56s25.072 56 56 56c14.562 0 27.823-5.561 37.783-14.671l67.958 40.775a56.088 56.088 0 00-1.74 13.897c0 30.928 25.072 56 56 56s56-25.072 56-56C360 321.072 334.928 296 304 296z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Gustavo Antão Website
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Subindo uma aplicação PHP no Kubernetes com Gitlab-CI - Parte 1 - Construindo a imagem da aplicação
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Gustavo Antão Website" class="md-nav__button md-logo" aria-label="Gustavo Antão Website">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M448 80v352c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V80c0-26.51 21.49-48 48-48h352c26.51 0 48 21.49 48 48zM304 296c-14.562 0-27.823 5.561-37.783 14.671l-67.958-40.775a56.339 56.339 0 000-27.793l67.958-40.775C276.177 210.439 289.438 216 304 216c30.928 0 56-25.072 56-56s-25.072-56-56-56-56 25.072-56 56c0 4.797.605 9.453 1.74 13.897l-67.958 40.775C171.823 205.561 158.562 200 144 200c-30.928 0-56 25.072-56 56s25.072 56 56 56c14.562 0 27.823-5.561 37.783-14.671l67.958 40.775a56.088 56.088 0 00-1.74 13.897c0 30.928 25.072 56 56 56s56-25.072 56-56C360 321.072 334.928 296 304 296z"/></svg>

    </a>
    Gustavo Antão Website
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../shell/" title="Dicas de Shell Scripting" class="md-nav__link">
      Dicas de Shell Scripting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../vim/" title="Dicas VIM" class="md-nav__link">
      Dicas VIM
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#por-que-php" class="md-nav__link">
    Por que PHP?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#antes-de-comecar" class="md-nav__link">
    Antes de começar
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#o-problema-de-utilizar-uma-imagem-padrao" class="md-nav__link">
    O problema de utilizar uma imagem padrão
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diferenca-de-tamanho-entre-as-imagens-oficiais" class="md-nav__link">
    Diferença de tamanho entre as imagens oficiais
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#builder-pattern" class="md-nav__link">
    Builder Pattern
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusao" class="md-nav__link">
    Conclusão
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="subindo-uma-aplicacao-php-no-kubernetes-com-gitlab-ci-parte-1-construindo-a-imagem-da-aplicacao">Subindo uma aplicação PHP no Kubernetes com Gitlab-CI - Parte 1 - Construindo a imagem da aplicação</h1>
<p>Este é o primeiro de 3 artigos que pretendo escrever e nele quero compartilhar um pouco sobre a construção de imagens otimizadas utilizando o Builder Pattern.</p>
<p><strong>Parte 2 - Criando os arquivos de manifesto da Aplicação (Kubernetes)</strong></p>
<p><strong>Parte 3 - Criando uma pipeline para o deploy com Gitlab-CI</strong></p>
<h2 id="por-que-php">Por que PHP?</h2>
<p>O artigo poderia ser escrito utilizando qualquer outra tecnologia como Golang, Python, Java, Node, etc… A escolha pelo PHP se dá por 2 motivos. O primeiro e mais óbvio é porque é a tecnologia que utilizo no dia-a-dia, no trabalho e tenho mais afinidade. O segundo motivo foi uma das razões que me levaram à escrever o artigo, justamente a menor quantidade de artigos e exemplos utilizando PHP. Durante meus estudos notei que era mais fácil encontrar informações sobre outras tecnologias sendo “deployadas” (se me permitem o neologismo) no Kubernetes do que PHP, por isso a escolha por ele.</p>
<h2 id="antes-de-comecar">Antes de começar</h2>
<p>Se você está lendo este artigo eu presumo que já esteja familiarizado com a utilização de containers com Docker, caso este não seja o seu caso eu sugiro fortemente que você assista a série “<a href="https://www.youtube.com/watch?v=0cDj7citEjE&amp;list=PLf-O3X2-mxDk1MnJsejJwqcrDC5kDtXEb">Descomplicando Docker</a>” do canal LinuxTips.</p>
<p>É importante antes de seguir lendo o artigo que você se familiarize com o conceito de imagens do Docker.</p>
<p>Se você já tem conhecimento sobre utilização de containers com Docker, abaixo eu vou demonstrar uma forma de construir imagens menores para sua aplicação utilizando uma boa prática para criação de containers chamada Builder Pattern. Para saber um pouco mais sobre a técnica, vale a pena assistir <a href="https://www.youtube.com/watch?v=wGz_cbtCiEA">este vídeo</a> do Sandeep Dinesh do Google. Aliás, recomendo assistir a toda série “<a href="https://www.youtube.com/watch?v=wGz_cbtCiEA&amp;list=PLIivdWyY5sqL3xfXz5xJvwzFW_tlQB_GB">Kubernetes Best Practices</a>” apresentada por ele.
Agora, sem mais delongas vamos ao que interessa</p>
<h2 id="o-problema-de-utilizar-uma-imagem-padrao">O problema de utilizar uma imagem padrão</h2>
<p>Primeiramente precisamos entender qual é a necessidade de criar imagens otimizadas sendo que seria muito mais fácil utilizar as imagens padrão encontradas no Docker Hub.</p>
<p><img alt="Senta que lá vem a história" src="https://gustavoantao.github.io/assets/la_vem_historia.jpg" /></p>
<p>Qual é o problema disso? Bem, vamos criar uma situação hipotética onde você tem um cluster Kubernetes rodando sua principal aplicação. Seu software é uma plataforma de comércio eletrônico rodando milhares de lojas de diversos tamanhos, desde pequenas lojas com 40 a 50 produtos até grandes lojas com milhares de produtos e vendendo milhões de reais por mês.</p>
<p>Pensar no gerenciamento de escala manual de um ambiente como este já é de arrepiar os cabelos, mas felizmente o Kubernetes nos oferece o autoscaling horizontal de pods e os Cloud Providers em suas soluções gerenciadas de K8s oferecem o autoscaling de worker nodes, permitindo que elasticidade e escalabilidade não sejam problemas. O ambiente naturalmente se estica e diminui automaticamente conforme a carga que recebe, mantendo sua plataforma estável e ao mesmo tempo economizando recursos em períodos de ociosidade. Tudo maravilhoso, cada vez que sobe a quantidade de requests a um nível que a plataforma não vai aguentar o autoscaling sobe novos nodes que baixam a imagem da sua aplicação e provisionam novos pods para atender estas requisições. E é aí que mora o problema! Imagine que seu maior cliente, resolve fazer uma ação de marketing no intervalo do jogo da final da copa e anuncia um desconto de 50% justamente nos itens que ele mais vende. Ah.. ele esqueceu de te informar a respeito.</p>
<p><img alt="Meteoro" src="https://gustavoantao.github.io/assets/meteoro.jpeg" /></p>
<p>O resultado será uma avalanche de requisições repentinamente chegando no seu cluster, logicamente que com o crescimento das requests o autoscaling provisionará novos nodes, talvez dezenas, talvez centenas, que terão cada um deles que fazer o download da imagem da sua app antes de provisionar os pods e começar a atender as requisições, é muito provável que durante algum tempo (talvez segundos, talvez minutos) requests sejam perdidas e seu cliente deixará de vender. É uma situação que não o deixará muito contente, lembre-se é seu maior cliente, que investiu pesado em marketing e teve prejuízo ao não conseguir atender a toda demanda que sua ação de marketing conseguiu atrair.</p>
<p>Utilizando imagens menores para sua app o tempo para subir um novo node será muito reduzido, e se não conseguir evitar 100% situações como a exemplificada acima, certamente vai minimizar muito o impacto.</p>
<h2 id="diferenca-de-tamanho-entre-as-imagens-oficiais">Diferença de tamanho entre as imagens oficiais</h2>
<p>Vamos primeiramente baixar a imagem oficial do PHP-FPM do Docker Hub:</p>
<pre><code>$ docker pull php:7.3-fpm
</code></pre>

<p>Vamos ver o tamanho da imagem default (baseada no Debian)</p>
<p><img alt="Default Debian" src="https://gustavoantao.github.io/assets/default_debian.png" /></p>
<p>Podemos observar que a imagem padrão, sem adição de nenhuma extensão do PHP possui 398MB de tamanho.</p>
<p>A imagem default do PHP é baseada no Debian, mas já é bem sabido que utilizar a distro Alpine Linux como base traz uma enorme economia de espaço na imagem e esta é a forma mais simples de se reduzir o tamanho da sua app. Vamos ver qual é o tamanho da imagem PHP-FPM oficial utilizando o Alpine:</p>
<pre><code>$ docker pull php:7.3-fpm-alpine
</code></pre>

<p><img alt="Default Alpine" src="https://gustavoantao.github.io/assets/default_alpine.png" /></p>
<p>Como podemos observar a imagem com Alpine tem apenas 74.6MB uma economia de 323.4MB se comparada à imagem Debian. Mas quem trabalha com PHP sabe que para levar uma aplicação à produção será necessário instalar diversas extensões que o PHP possui, seja para conexão com banco de dados, autenticação com LDAP, compactação, manipulação de imagens etc…</p>
<p>Para termos uma noção eu criei um Dockerfile utilizando a imagem base padrão do PHP-FPM e adicionando algumas extensões que são frequentemente usadas:</p>
<ul>
<li>mbstring</li>
<li>zip</li>
<li>intl</li>
<li>gd</li>
<li>imap</li>
<li>xml</li>
<li>mysqli</li>
<li>json</li>
<li>bcmath</li>
<li>bz2</li>
<li>pdo_mysql</li>
<li>ldap</li>
</ul>
<p>Além dessas extensões deixei a imagem preparada com o composer já instalado para o gerenciamento de dependências da aplicação. Vejamos o Dockerfile dessa imagem:</p>
<pre><code>FROM php:7.3-fpm
RUN apt-get update &amp;&amp; apt-get upgrade
# PHP MBSTRING
RUN docker-php-ext-install mbstring
# PHP-ZIP
RUN apt-get install zlib1g-dev libzip-dev -y
RUN docker-php-ext-install zip
# PHP-INTL
RUN apt-get install icu-devtools libicu-dev
RUN docker-php-ext-configure intl &amp;&amp; docker-php-ext-install intl
# PHP-GD
RUN apt-get install libpng-dev -y
RUN docker-php-ext-configure gd &amp;&amp; docker-php-ext-install gd
# PHP-IMAP
RUN apt-get install libc-client-dev libkrb5-dev -y
RUN docker-php-ext-configure imap --with-kerberos --with-imap-ssl &amp;&amp; docker-php-ext-install imap
# PHP-XML
RUN apt-get install libxml2-dev
RUN docker-php-ext-configure xml &amp;&amp; docker-php-ext-install xml
# PHP-MYSQLi
RUN docker-php-ext-configure mysqli &amp;&amp; docker-php-ext-install mysqli
# PHP-JSON
RUN docker-php-ext-configure json &amp;&amp; docker-php-ext-install json
# PHP-BCMATH
RUN docker-php-ext-configure bcmath &amp;&amp; docker-php-ext-install bcmath
# PHP-BZ2
RUN apt-get install libbz2-dev -y
RUN docker-php-ext-configure bz2 &amp;&amp; docker-php-ext-install bz2
# PHP-PDO
RUN docker-php-ext-configure pdo &amp;&amp; docker-php-ext-install pdo
RUN docker-php-ext-configure pdo_mysql &amp;&amp; docker-php-ext-install pdo_mysql
# PHP-LDAP
RUN apt-get install libldap2-dev
RUN docker-php-ext-configure ldap &amp;&amp; docker-php-ext-install ldap
# Instalando o composer
RUN php -r &quot;copy('https://getcomposer.org/installer', 'composer-setup.php');&quot; &amp;&amp; \
php composer-setup.php &amp;&amp; \
php -r &quot;unlink('composer-setup.php');&quot; &amp;&amp; \
mv composer.phar /usr/local/bin/composer &amp;&amp; \
/usr/local/bin/composer global require hirak/prestissimo
</code></pre>

<p>Para <em>“buildar”</em> esse Dockerfile executamos:</p>
<pre><code>$ docker build -t php7.3-ext-debian .
</code></pre>

<p>Vejamos com que tamanho essa imagem ficou agora:</p>
<p><img alt="Ext Debian" src="https://gustavoantao.github.io/assets/ext_debian.png" /></p>
<p>São 126MB à mais na imagem oficial Debian após a adição das extensões, qual será o resultado dessas adições na imagem alpine? O Dockerfile Alpine ficou assim:</p>
<pre><code>FROM php:7.3-fpm-alpine
RUN apk add --update php libstdc++
# PHP MBSTRING
RUN docker-php-ext-install mbstring
# PHP-ZIP
RUN apk add --update zlib-dev libzip-dev
RUN docker-php-ext-install zip
# PHP-INTL
RUN apk add --update icu-dev php7-intl
RUN docker-php-ext-configure intl &amp;&amp; docker-php-ext-install intl
# PHP-GD
RUN apk add --update libgd libpng-dev
RUN docker-php-ext-configure gd &amp;&amp; docker-php-ext-install gd
# PHP-IMAP
RUN apk add --update imap-dev
RUN docker-php-ext-configure imap &amp;&amp; docker-php-ext-install imap
# PHP-XML
RUN apk add --no-cache -X http://dl-cdn.alpinelinux.org/alpine/edge/testing libxml++-dev
RUN docker-php-ext-configure xml &amp;&amp; docker-php-ext-install xml
# PHP-MYSQLi
RUN docker-php-ext-configure mysqli &amp;&amp; docker-php-ext-install mysqli
# PHP-JSON
RUN docker-php-ext-configure json &amp;&amp; docker-php-ext-install json
# PHP-BCMATH
RUN docker-php-ext-configure bcmath &amp;&amp; docker-php-ext-install bcmath
# PHP-BZ2
RUN docker-php-ext-configure bz2 &amp;&amp; docker-php-ext-install bz2
# PHP-PDO
RUN docker-php-ext-configure pdo &amp;&amp; docker-php-ext-install pdo
RUN docker-php-ext-configure pdo_mysql &amp;&amp; docker-php-ext-install pdo_mysql
# PHP-LDAP
RUN apk add --update openldap-dev
RUN docker-php-ext-configure ldap &amp;&amp; docker-php-ext-install ldap
# Instalando o composer
RUN php -r &quot;copy('https://getcomposer.org/installer', 'composer-setup.php');&quot; &amp;&amp; \
php composer-setup.php &amp;&amp; \
php -r &quot;unlink('composer-setup.php');&quot; &amp;&amp; \
mv composer.phar /usr/local/bin/composer &amp;&amp; \
/usr/local/bin/composer global require hirak/prestissimo
</code></pre>

<p>E o resuldado:</p>
<p><img alt="Ext Alpine" src="https://gustavoantao.github.io/assets/ext_alpine.png" /></p>
<p>Com 304MB a imagem está muito maior que que a imagem original Alpine mas ainda 220MB menor que a imagem Debian com as extensões e ainda consegue ser menor que a imagem Debian original.</p>
<p>Mas é possível fazer melhor, como disse no início do artigo, ao utilizarmos o Builder Pattern para a criação das imagens podemos economizar ainda mais espaço em disco.</p>
<h2 id="builder-pattern">Builder Pattern</h2>
<p>Mas o que cargas d’água vem a ser esse tal padrão?</p>
<p>Bem, ao realizarmos as instalações das extensões (ou a compilação para o caso de linguagens compiladas) o sistema baixa diversas bibliotecas e dependências que somente serão utilizadas durante a instalação, inflando a imagem com arquivos que serão desnecessários para o funcionamento da aplicação. O Docker oferece um recurso chamado de multi-stage build, que nos permite fazer toda a geração de dependências em uma imagem temporária e em seguida copiar apenas os arquivos que interessam para a imagem final, tornando-a muito menor. Este é o <strong>Builder Pattern</strong>.</p>
<p><strong>Mas como fazemos isso?</strong></p>
<p>Um Dokerfile normalmente possui uma instrução FROM que determina qual será a imagem base utilizada seguida das outras instruções para construção da imagem (COPY, RUN, CMD, etc).</p>
<p>No caso do Builder Pattern utiliza-se um ou mais comandos FROM pra gerar as dependências que posteriormente serão copiadas para a imagem final.</p>
<p>Veja o exemplo:</p>
<pre><code>###############################################################################
# Imagem PHP-7.3 otimizada para uso no cluster
# Multi-stage build (builder pattern)
# Primeiro realiza o build das extensões necessárias
FROM php:7.3-fpm-alpine AS extensions_source
ENV EXT_DIR=/usr/src/php/ext
RUN mkdir -p ${EXT_DIR}
RUN apk add --update php libstdc++
# PHP MBSTRING
RUN docker-php-ext-install mbstring
# PHP-ZIP
RUN apk add --update zlib-dev libzip-dev
RUN docker-php-ext-install zip
# PHP-INTL
RUN apk add --update icu-dev php7-intl
RUN docker-php-ext-configure intl &amp;&amp; docker-php-ext-install intl
# PHP-GD
RUN apk add --update libgd libpng-dev
RUN docker-php-ext-configure gd &amp;&amp; docker-php-ext-install gd
# PHP-IMAP
RUN apk add --update imap-dev
RUN docker-php-ext-configure imap &amp;&amp; docker-php-ext-install imap
# PHP-XML
RUN apk add --no-cache -X http://dl-cdn.alpinelinux.org/alpine/edge/testing libxml++-dev
RUN docker-php-ext-configure xml &amp;&amp; docker-php-ext-install xml
# PHP-MYSQLi
RUN docker-php-ext-configure mysqli &amp;&amp; docker-php-ext-install mysqli
# PHP-JSON
RUN docker-php-ext-configure json &amp;&amp; docker-php-ext-install json
# PHP-BCMATH
RUN docker-php-ext-configure bcmath &amp;&amp; docker-php-ext-install bcmath
# PHP-BZ2
RUN docker-php-ext-configure bz2 &amp;&amp; docker-php-ext-install bz2
# PHP-PDO
RUN docker-php-ext-configure pdo &amp;&amp; docker-php-ext-install pdo
RUN docker-php-ext-configure pdo_mysql &amp;&amp; docker-php-ext-install pdo_mysql
# PHP-LDAP
RUN apk add --update openldap-dev
RUN docker-php-ext-configure ldap &amp;&amp; docker-php-ext-install ldap
# Estágio 2
# Faz o build da imagem limpa, apenas copiando os arquivos necessários da imagem temporária
FROM php:7.3-fpm-alpine
ENV EXT_DIR=/usr/local/lib/php/extensions/no-debug-non-zts-20180731/
ENV LIB_DIR=/usr/lib
COPY --from=extensions_source \
${EXT_DIR}/mbstring.so \
${EXT_DIR}/zip.so \
${EXT_DIR}/intl.so \
${EXT_DIR}/gd.so \
${EXT_DIR}/imap.so \
${EXT_DIR}/xml.so \
${EXT_DIR}/mysqli.so \
${EXT_DIR}/json.so \
${EXT_DIR}/bcmath.so \
${EXT_DIR}/bz2.so \
${EXT_DIR}/pdo.so \
${EXT_DIR}/pdo_mysql.so \
${EXT_DIR}/ldap.so ${EXT_DIR}/
RUN ln -s ${LIB_DIR}/libzip.so ${LIB_DIR}/libzip.so.5 \
&amp;&amp; ln -s ${LIB_DIR}/libcrypto.so.1.1 ${LIB_DIR}/libcrypto.so \
&amp;&amp; ln -s ${LIB_DIR}/libssl.so.1.1 ${LIB_DIR}/libssl.so \
&amp;&amp; ln -s ${LIB_DIR}/libbz2.so ${LIB_DIR}/libbz2.so.1 \
&amp;&amp; ln -s ${LIB_DIR}/libicuio.so ${LIB_DIR}/libicuio.so.64 \
&amp;&amp; ln -s ${LIB_DIR}/libicui18n.so ${LIB_DIR}/libicui18n.so.64 \
&amp;&amp; ln -s ${LIB_DIR}/libicuuc.so ${LIB_DIR}/libicuuc.so.64 \
&amp;&amp; ln -s ${LIB_DIR}/libicudata.so ${LIB_DIR}/libicudata.so.64 \
&amp;&amp; ln -s ${LIB_DIR}/libldap.so ${LIB_DIR}/libldap-2.4.so.2 \
&amp;&amp; ln -s ${LIB_DIR}/liblber.so ${LIB_DIR}/liblber-2.4.so.2 \
&amp;&amp; ln -s ${LIB_DIR}/libsasl2.so ${LIB_DIR}/libsasl2.so.3 \
&amp;&amp; ln -s ${LIB_DIR}/libpng.so ${LIB_DIR}/libpng16.so \
&amp;&amp; ln -s ${LIB_DIR}/libpng.so ${LIB_DIR}/libpng16.so.16 \
&amp;&amp; ln -s ${LIB_DIR}/libc-client.so ${LIB_DIR}/libc-client.so.1
COPY --from=extensions_source \
${LIB_DIR}/libzip.so \
${LIB_DIR}/../../lib/libcrypto.so.1.1 \
${LIB_DIR}/../../lib/libssl.so.1.1 \
${LIB_DIR}/libstdc* \
${LIB_DIR}/libicudata.so \
${LIB_DIR}/libicui18n.so \
${LIB_DIR}/libicuio.so \
${LIB_DIR}/libicutest.so \
${LIB_DIR}/libicutu.so \
${LIB_DIR}/libicuuc.so \
${LIB_DIR}/libgcc_s.so.1 \
${LIB_DIR}/libpng.so \
${LIB_DIR}/libc-client.so \
${LIB_DIR}/libbz2.so \
${LIB_DIR}/libldap.so \
${LIB_DIR}/libldap_r-2.4.so.2 \
${LIB_DIR}/libldap_r.so \
${LIB_DIR}/liblber.so \
${LIB_DIR}/libsasl2.so ${LIB_DIR}/
RUN docker-php-ext-enable zip mbstring intl gd imap xml mysqli json bcmath \
bz2 pdo pdo_mysql ldap
# Refaço a cópia pois o comando docker-php-ext-enable faz purge de algumas libs
COPY --from=extensions_source ${LIB_DIR}/libstdc* ${LIB_DIR}/libgcc_s.so.1 ${LIB_DIR}/
# Instalando o composer
RUN php -r &quot;copy('https://getcomposer.org/installer', 'composer-setup.php');&quot; &amp;&amp; \
php composer-setup.php &amp;&amp; \
php -r &quot;unlink('composer-setup.php');&quot; &amp;&amp; \
mv composer.phar /usr/local/bin/composer &amp;&amp; \
/usr/local/bin/composer global require hirak/prestissimo
# Limpando a imagem
RUN rm -rf /var/cache/apk/* /tmp/* /usr/share/man /usr/local/lib/php/doc/*
</code></pre>

<p>Note que primeiramente eu declaro um FROM e o nomeio utilizando o parametro AS e nesse estágio são realizadas as instalações das extensões necessárias. Concluídas as instalações, é realizada a declaração de um novo FROM que fará o build da imagem final. Neste estágio utilizando o parâmetro COPY --from=nome_do_estágio é possível referenciar o estágio anterior e copiar apenas os arquivos que nos interessam.
Adicionalmente, eu adiciono ao final do arquivo um comando para excluir arquivos de cache, temporários e documentação.</p>
<p>Vejamos o resultado:</p>
<p><img alt="Builder Alpine" src="https://gustavoantao.github.io/assets/builder_alpine.png" /></p>
<p>A imagem gerada utilizando o Builder Pattern ficou com 156MB.
São 148MB a menos que a imagem Alpine e 368MB de diferença para a imagem Debian. Uma redução de 70% no tamanho original da imagem Debian com as extensões.</p>
<h2 id="conclusao">Conclusão</h2>
<p>Vimos que:
1. Com o simples fato de optarmos pela distro Alpine Linux na hora de construir nossos containers podemos criar imagens muito mais enxutas;
2. Que com um pouquinho de trabalho, usando o Builder Pattern é possível otimizar ainda mais estas imagens;
3. Quando estamos falando de imagens de container para o Kubernetes, tamanho é sim importante <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M117.1 384.1c-25.8 3.7-84 13.7-100.9 30.6-21.9 21.9-21.5 57.9.9 80.3s58.3 22.8 80.3.9C114.3 479 124.3 420.8 128 395c.8-6.4-4.6-11.8-10.9-10.9zm-41.2-41.7C40.3 268 53 176.1 114.6 114.6 152.4 76.8 202.6 56 256 56c36.2 0 70.8 9.8 101.2 27.7 3.8-20.3 8-36.1 12-48.3C333.8 17.2 294.9 8 256 8 192.5 8 129.1 32.2 80.6 80.6c-74.1 74.1-91.3 183.4-52 274 12.2-4.1 27.7-8.3 47.3-12.2zm352.3-187.6c45 76.6 34.9 176.9-30.8 242.6-37.8 37.8-88 58.6-141.4 58.6-30.5 0-59.8-7-86.4-19.8-3.9 19.5-8 35-12.2 47.2 31.4 13.6 65 20.6 98.7 20.6 63.5 0 126.9-24.2 175.4-72.6 78.1-78.1 93.1-195.4 45.2-288.6-12.3 4-28.2 8.1-48.5 12zm-33.3-26.9c25.8-3.7 84-13.7 100.9-30.6 21.9-21.9 21.5-57.9-.9-80.3s-58.3-22.8-80.3-.9C397.7 33 387.7 91.2 384 117c-.8 6.4 4.6 11.8 10.9 10.9zm-187 108.3c-3-3-7.2-4.2-11.4-3.2L106 255.7c-5.7 1.4-9.5 6.7-9.1 12.6.5 5.8 5.1 10.5 10.9 11l52.3 4.8 4.8 52.3c.5 5.8 5.2 10.4 11 10.9h.9c5.5 0 10.3-3.7 11.7-9.1l22.6-90.5c1-4.2-.2-8.5-3.2-11.5zm39.7-25.1l90.5-22.6c5.7-1.4 9.5-6.7 9.1-12.6-.5-5.8-5.1-10.5-10.9-11l-52.3-4.8-4.8-52.3c-.5-5.8-5.2-10.4-11-10.9-5.6-.1-11.2 3.4-12.6 9.1L233 196.5c-1 4.1.2 8.4 3.2 11.4 5 5 11.3 3.2 11.4 3.2zm52 88.5c-29.1 29.1-59.7 52.9-83.9 65.4-9.2 4.8-10 17.5-1.7 23.4 38.9 27.7 107 6.2 143.7-30.6S416 253 388.3 214.1c-5.8-8.2-18.5-7.6-23.4 1.7-12.3 24.2-36.2 54.7-65.3 83.8z"/></svg></span>.</p>
<p>No próximo post, entrarei no mundo do Kubernetes propriamente dito criando os arquivos de manifesto para o deploy de uma app PHP no K8s.</p>
<p>Até lá!</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"search.result.none": "Nenhum resultado encontrado", "search.result.placeholder": "Digite para iniciar a busca", "search.result.other": "# resultados encontrados", "search.config.separator": "[\\s\\-]+", "clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.result.one": "1 resultado encontrado", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>